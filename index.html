<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Easydine Voting</title>
  <style>
    body { font-family:sans-serif; max-width:700px; margin:auto; padding:2rem; background:#f9f9f9; }
    h1 { text-align:center; margin-bottom:1.5rem; }
    .block { margin-bottom:1.5rem; padding:1rem; background:#fff; border-radius:4px; box-shadow:0 1px 3px rgba(0,0,0,0.1); }
    label { display:block; font-weight:bold; margin-bottom:0.5rem; }
    select { width:100%; padding:0.5rem; font-size:1rem; }
    button { margin-top:1rem; padding:1rem; width:100%; background:#007aff; color:#fff; border:none; border-radius:4px; cursor:pointer; }
    button:disabled { background:#999; cursor:default; }
    .error { color:red; }
  </style>
</head>
<body>
  <h1>Wöchentliche Rezept-Abstimmung</h1>

  <div id="rezepte">
    <p>Lade Rezepte… bitte warten.</p>
  </div>

  <button id="submit-btn" disabled>Abstimmen &amp; Speichern</button>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const WORKER = 'https://easydine-voting.daniel-rossmann.workers.dev';
      const params = new URLSearchParams(window.location.search);
      const hh = params.get('household_id') || '';

      let rezepte = [];
      const rezepteContainer = document.getElementById('rezepte');
      const submitBtn = document.getElementById('submit-btn');

      // Lade die Rezepte per GET
      async function loadRecipes() {
        try {
          const response = await fetch(WORKER + '?household_id=' + encodeURIComponent(hh));
          if (!response.ok) throw new Error('HTTP ' + response.status);
          rezepte = await response.json();  // <-- erwartet ein Array

          // leere den Container und baue die Blocks
          rezepteContainer.innerHTML = '';
          rezepte.forEach((r, i) => {
            const block = document.createElement('div');
            block.className = 'block';
            block.innerHTML =
              '<label for="vote_' + i + '">' + (i+1) + '. ' + r.name + '</label>' +
              '<select id="vote_' + i + '">' +
                '<option value="1">★☆☆☆☆ (1)</option>' +
                '<option value="2">★★☆☆☆ (2)</option>' +
                '<option value="3">★★★☆☆ (3)</option>' +
                '<option value="4">★★★★☆ (4)</option>' +
                '<option value="5">★★★★★ (5)</option>' +
              '</select>';
            rezepteContainer.appendChild(block);
          });

          submitBtn.disabled = false;
        } catch(err) {
          console.error('loadRecipes error', err);
          rezepteContainer.innerHTML = '<p class="error">Fehler beim Laden der Rezepte.</p>';
        }
      }

      // Submit-Handler
      submitBtn.addEventListener('click', async () => {
        submitBtn.disabled = true;
        const votes = rezepte.map((r, i) => ({
          recipe_id: r.id,
          vote: Number(document.getElementById('vote_' + i).value)
        }));
        try {
          const resp = await fetch(WORKER, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ household_id: hh, votes })
          });
          const result = await resp.json();
          if (result.success) {
            alert('Danke fürs Voting!');
          } else {
            alert('Fehler beim Speichern: ' + (result.error || 'unbekannt'));
          }
        } catch(err) {
          console.error('submit error', err);
          alert('Netzwerk-Fehler beim Speichern.');
        } finally {
          submitBtn.disabled = false;
        }
      });

      loadRecipes();
    });
  </script>
</body>
</html>
