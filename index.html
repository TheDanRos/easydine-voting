<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Wöchentliche Rezept-Abstimmung</title>
  <style>
    body { font-family: sans-serif; max-width: 700px; margin: auto; padding: 2rem; background: #f9f9f9 }
    h1 { text-align: center }
    .rezept-block { background:#fff; padding:1rem; margin-bottom:1rem; border-radius:4px; box-shadow:0 1px 3px rgba(0,0,0,0.1) }
    label { font-weight:600; display:block; margin-bottom:.5rem }
    select { width:100%; padding:.5rem; margin-bottom:.5rem }
    button { padding:1rem; width:100%; background:#007aff; color:#fff; font-size:1rem; border:none; border-radius:4px; cursor:pointer }
    .error { color:#c00; font-weight:600; margin:1rem 0 }
  </style>
</head>
<body>
  <h1>Wöchentliche Rezept-Abstimmung</h1>

  <form id="voting-form">
    <div id="rezepte">
      <p>Lade Rezepte… bitte warten.</p>
    </div>
    <button type="submit">Abstimmen &amp; Speichern</button>
  </form>

  <script>
    // 1) Deine Worker-URL hier einfügen:
    const WORKER_URL = 'https://easydine-voting.daniel-rossmann.workers.dev/'

    // URL-Parameter auslesen
    const params    = new URLSearchParams(window.location.search)
    const household = params.get('household_id')
    const voting    = params.get('voting_id')

    const container = document.getElementById('rezepte')

    if (!household || !voting) {
      container.innerHTML = '<p class="error">Fehler: Haushalt oder voting_id fehlt in der URL.</p>'
      document.querySelector('button').disabled = true
      throw new Error('Missing URL parameters')
    }

    // 2) Rezepte laden
    async function loadRecipes() {
      try {
        const res = await fetch(`${WORKER_URL}?household_id=${encodeURIComponent(household)}&voting_id=${encodeURIComponent(voting)}`)
        if (!res.ok) throw new Error(`HTTP ${res.status}`)
        const recipes = await res.json()
        if (!Array.isArray(recipes) || recipes.length === 0) {
          container.innerHTML = '<p class="error">Keine Rezepte gefunden.</p>'
          return
        }

        // Formular-Fields generieren
        container.innerHTML = ''
        recipes.forEach((r,i) => {
          const d = document.createElement('div')
          d.className = 'rezept-block'
          d.innerHTML = `
            <label for="vote_${i}">${i+1}. ${r.name}</label>
            <select id="vote_${i}">
              <option value="1">★☆☆☆☆</option>
              <option value="2">★★☆☆☆</option>
              <option value="3">★★★☆☆</option>
              <option value="4">★★★★☆</option>
              <option value="5">★★★★★</option>
            </select>
            <input type="hidden" name="recipe_id_${i}" value="${r.id}">
          `
          container.appendChild(d)
        })

      } catch(err) {
        console.error(err)
        container.innerHTML = `<p class="error">Fehler beim Laden der Rezepte: ${err.message}</p>`
      }
    }

    // 3) Vote-Form abschicken
    document.getElementById('voting-form')
      .addEventListener('submit', async e => {
        e.preventDefault()
        const votes = []
        document.querySelectorAll('select[id^="vote_"]').forEach(sel => {
          const idx = sel.id.split('_')[1]
          votes.push({
            recipe_id: document.querySelector(`input[name="recipe_id_${idx}"]`).value,
            vote:      Number(sel.value)
          })
        })

        const payload = { household_id: household, voting_id: voting, votes }

        try {
          const res  = await fetch(WORKER_URL, {
            method: 'POST',
            headers: { 'Content-Type':'application/json' },
            body: JSON.stringify(payload)
          })
          const json = await res.json()
          if (json.success) {
            alert('Danke für Dein Voting!')
          } else {
            throw new Error(json.error||'Unbekannter Fehler')
          }
        } catch(err) {
          console.error(err)
          alert('Fehler beim Speichern: '+err.message)
        }
      })

    // Kick off
    loadRecipes()
  </script>
</body>
</html>
