<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Easydine Voting</title>
  <style>
    body { font-family: sans-serif; max-width:700px; margin:auto; padding:2rem; background:#f9f9f9 }
    h1 { text-align:center; margin-bottom:1.5rem }
    .block { margin-bottom:1.5rem; padding:1rem; background:#fff; border-radius:4px; box-shadow:0 1px 3px rgba(0,0,0,0.1) }
    select, button { width:100%; padding:0.5rem; font-size:1rem }
    button { margin-top:1rem; background:#007aff; color:#fff; border:none; border-radius:4px; cursor:pointer }
    button:disabled { background:#999; cursor:default }
    .error { color:red; }
  </style>
</head>
<body>
  <h1>Wöchentliche Rezept-Abstimmung</h1>

  <!-- Anzahl-Gerichte-Select war hier, entferne ihn erstmal, bis die GET/POST-Synchronisierung fertig ist -->

  <div id="rezepte">
    <p>Lade Rezepte… bitte warten.</p>
  </div>
  <button id="submit-btn" disabled>Abstimmen & Speichern</button>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const WORKER = 'https://easydine-voting.daniel-rossmann.workers.dev'
      const params = new URLSearchParams(window.location.search)
      const hh = params.get('household_id') || ''

      let rezepte = []

      const container = document.getElementById('rezepte')
      const btn = document.getElementById('submit-btn')

      // 1) Rezepte laden
      async function loadRecipes() {
        try {
          const res = await fetch(\`\${WORKER}?household_id=\${encodeURIComponent(hh)}\`)
          if (!res.ok) throw new Error('HTTP ' + res.status)
          rezepte = await res.json()   // <-- hier direkt Array

          container.innerHTML = ''
          rezepte.forEach((r, i) => {
            const div = document.createElement('div')
            div.className = 'block'
            div.innerHTML = \`
              <label for="vote_\${i}">\${i+1}. \${r.name}</label>
              <select id="vote_\${i}">
                <option value="1">★☆☆☆☆ (1)</option>
                <option value="2">★★☆☆☆ (2)</option>
                <option value="3">★★★☆☆ (3)</option>
                <option value="4">★★★★☆ (4)</option>
                <option value="5">★★★★★ (5)</option>
              </select>
            \`
            container.appendChild(div)
          })

          btn.disabled = false  // jetzt darf man absenden
        } catch (err) {
          console.error('loadRecipes error', err)
          container.innerHTML = '<p class="error">Fehler beim Laden der Rezepte.</p>'
        }
      }

      // 2) Submit-Handler
      btn.addEventListener('click', async () => {
        btn.disabled = true
        const votes = rezepte.map((r, i) => ({
          recipe_id: r.id,
          vote: Number(document.getElementById(\`vote_\${i}\`).value)
        }))

        try {
          const resp = await fetch(WORKER, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ household_id: hh, votes })
          })
          const json = await resp.json()
          if (json.success) {
            alert('Danke fürs Voting!')
          } else {
            alert('Fehler beim Speichern: ' + (json.error||'unbekannt'))
          }
        } catch (err) {
          console.error('submit error', err)
          alert('Netzwerkfehler.')
        } finally {
          btn.disabled = false
        }
      })

      loadRecipes()
    })
  </script>
</body>
</html>
