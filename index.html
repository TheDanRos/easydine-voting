<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Easydine Voting</title>
  <style>
    body { font-family: sans-serif; max-width:700px; margin:auto; padding:2rem; background:#f9f9f9 }
    .block { margin-bottom:1.5rem; padding:1rem; background:#fff; border-radius:4px; box-shadow:0 1px 3px rgba(0,0,0,0.1) }
    button { padding:1rem; width:100%; background:#007aff; color:#fff; border:none; border-radius:4px; cursor:pointer }
    button:disabled { background:#999; }
  </style>
</head>
<body>
  <h1>Wöchentliche Rezept-Abstimmung</h1>
  <form id="voting-form">
    <input type="hidden" id="household-id" />
    <div id="rezepte"><p>Lade Rezepte…</p></div>
    <button type="submit">Abstimmen</button>
  </form>

  <script>
    // === KONFIG: nur hier deine Worker-URL eintragen ===
    const WORKER = 'https://easydine-voting.daniel-rossmann.workers.dev';
    // ====================================================

    console.log('Script startet');
    const params = new URLSearchParams(window.location.search);
    const hh = params.get('household_id') || '';
    document.getElementById('household-id').value = hh;
    let rezepte = [];

    async function loadRecipes() {
      console.log('loadRecipes() startet, household_id =', hh);
      try {
        const res = await fetch(`${WORKER}?household_id=${encodeURIComponent(hh)}`);
        rezepte = await res.json();
        console.log('Rezepte geladen:', rezepte);
        const cont = document.getElementById('rezepte');
        cont.innerHTML = '';
        rezepte.forEach((r,i) => {
          const d = document.createElement('div');
          d.className = 'block';
          d.innerHTML = `
            <label for="vote_${i}">${i+1}. ${r.name}</label>
        <select id="vote_${i}">
           <option value="1">★☆☆☆☆ (1)</option>
           <option value="2">★★☆☆☆ (2)</option>
           <option value="3">★★★☆☆ (3)</option>
           <option value="4">★★★★☆ (4)</option>
           <option value="5">★★★★★ (5)</option>
         </select>
          `;
          cont.appendChild(d);
        });
      } catch(err) {
        console.error('Fehler beim Laden:', err);
        document.getElementById('rezepte').innerHTML = '<p style="color:red">Fehler beim Laden der Rezepte.</p>';
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      console.log('DOM fertig geladen');
      const form = document.getElementById('voting-form');
      console.log('Form gefunden:', form);
      form.addEventListener('submit', async e => {
        e.preventDefault();
        console.log('Submit-Handler ausgelöst');
        const btn = form.querySelector('button[type="submit"]');
        btn.disabled = true;

        const votes = rezepte.map((r,i) => ({
          recipe_id: r.id,
          vote: document.getElementById(`vote_${i}`).value
        }));
        console.log('Votes-Array:', votes);

        try {
          const response = await fetch(WORKER, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ household_id: hh, votes })
          });
          const json = await response.json();
          console.log('Server-Antwort:', json);
          if (json.success) alert('Danke fürs Voting!');
          else alert('Fehler beim Speichern: ' + (json.error||'unbekannt'));
        } catch(err) {
          console.error('Netzwerk-Fehler:', err);
          alert('Netzwerk-Fehler beim Speichern.');
        } finally {
          btn.disabled = false;
        }
      });

      loadRecipes();
    });
  </script>
</body>
</html>
