<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Easydine Rezept-Abstimmung</title>
  <style>
    body {
      font-family: sans-serif;
      max-width: 700px;
      margin: auto;
      padding: 2rem;
      background: #f9f9f9;
    }
    h1 {
      text-align: center;
      margin-bottom: 1.5rem;
    }
    .block {
      background: white;
      padding: 1rem;
      margin-bottom: 1.5rem;
      border-radius: 4px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    label {
      display: block;
      font-weight: bold;
      margin-bottom: 0.5rem;
    }
    select, button {
      width: 100%;
      padding: 0.5rem;
      font-size: 1rem;
    }
    button {
      margin-top: 1rem;
      background: #007aff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:disabled {
      background: #999;
      cursor: default;
    }
    .error {
      color: red;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>Wöchentliche Rezept-Abstimmung</h1>

  <!-- 1) Auswahl Anzahl Gerichte -->
  <div class="block">
    <label for="count">Wie viele Gerichte sollen geplant werden?</label>
    <select id="count"></select>
  </div>

  <!-- 2) Container für die Rezepte -->
  <div id="rezepte" class="block">
    <p>Lade Rezepte… bitte warten.</p>
  </div>

  <!-- 3) Absende-Button -->
  <button id="submit-btn" disabled>Abstimmen &amp; Speichern</button>

  <!-- 4) Script am Ende des Body -->
  <script>
document.addEventListener('DOMContentLoaded', () => {
  const WORKER = 'https://easydine-voting.daniel-rossmann.workers.dev';
  const params      = new URLSearchParams(location.search);
  const householdId = params.get('household');    // kein Unterstrich!
  const votingId    = params.get('voting_id');

  const rezContainer = document.getElementById('rezepte');
  const countSelect  = document.getElementById('count');
  const btn          = document.getElementById('submit-btn');
  let recipes = [];

  if (!householdId || !votingId) {
    rezContainer.innerHTML = '<p class="error">Fehler: household oder voting_id fehlt in der URL.</p>';
    return;
  }

  // Count-Select füllen
  for (let i = 1; i <= 10; i++) {
    const opt = document.createElement('option');
    opt.value = i; opt.textContent = i;
    countSelect.appendChild(opt);
  }

  // Rezepte laden
  async function loadRecipes() {
    try {
      const resp = await fetch(
        `${WORKER}` +
        `?household_id=${encodeURIComponent(householdId)}` +
        `&voting_id=${encodeURIComponent(votingId)}`
      );
      if (!resp.ok) throw new Error('Server antwortete mit ' + resp.status);
      const data = await resp.json();
      window.__VOTING_RECORD_ID = data.voting_record_id;
      recipes = data.recipes;

      rezContainer.innerHTML = '';
      recipes.forEach((r,i) => {
        const div = document.createElement('div');
        div.className = 'block';
        div.innerHTML = `
          <label for="vote_${i}">${i+1}. ${r.name}</label>
          <select id="vote_${i}">
            <option value="1">★☆☆☆☆ (1)</option>
            <option value="2">★★☆☆☆ (2)</option>
            <option value="3">★★★☆☆ (3)</option>
            <option value="4">★★★★☆ (4)</option>
            <option value="5">★★★★★ (5)</option>
          </select>
        `;
        rezContainer.appendChild(div);
      });

      btn.disabled = false;
    } catch (err) {
      console.error(err);
      rezContainer.innerHTML = '<p class="error">Fehler beim Laden der Rezepte.</p>';
    }
  }

  // Absenden
  btn.addEventListener('click', async () => {
    btn.disabled = true;
    const count = Number(countSelect.value);
    const votes = recipes.map((r,i) => ({
      recipe_id: r.id,
      vote:      Number(document.getElementById(`vote_${i}`).value)
    }));

    try {
      const resp = await fetch(WORKER, {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({
          household_id:     householdId,            // korrekte Variable
          voting_record_id: window.__VOTING_RECORD_ID,
          count,
          votes
        })
      });
      const j = await resp.json();
      if (j.success) {
        alert('Danke fürs Voting!');
      } else {
        alert('Fehler: ' + (j.error||'unbekannt'));
      }
    } catch (err) {
      console.error(err);
      alert('Netzwerk-Fehler.');
    } finally {
      btn.disabled = false;
    }
  });

  loadRecipes();
});
</script>
</body>
</html>
