<script>
document.addEventListener('DOMContentLoaded', () => {
  const WORKER = 'https://easydine-voting.daniel-rossmann.workers.dev';
  const params = new URLSearchParams(location.search);

  // Hol beide Parameter aus der URL:
  const householdId = params.get('household');
  const votingId    = params.get('voting_id');

  let rezepte = [];
  const rezContainer = document.getElementById('rezepte');
  const btn          = document.getElementById('submit-btn');
  const countSelect  = document.getElementById('count');

  // 1️⃣ Count-Select füllen:
  for (let i = 1; i <= 10; i++) {
    const o = document.createElement('option');
    o.value = i; o.textContent = i;
    countSelect.appendChild(o);
  }

  // 2️⃣ Rezepte laden – wir schicken jetzt both Params:
  async function loadRecipes() {
    try {
      const res = await fetch(
        WORKER 
        + '?household_id=' + encodeURIComponent(householdId)
        + '&voting_id='    + encodeURIComponent(votingId)
      );
      if (!res.ok) throw new Error('HTTP ' + res.status);
      // der Worker liefert jetzt { voting_record_id, recipes: [...] }
      const { voting_record_id, recipes } = await res.json();
      // Merke dir die ID für POST
      window.__VOTING_RECORD_ID = voting_record_id;

      // Rezepte in DOM bauen
      rezContainer.innerHTML = '';
      rezepte = recipes;
      recipes.forEach((r,i) => {
        const d = document.createElement('div');
        d.className = 'block';
        d.innerHTML = 
          '<label for="vote_' + i + '">' + (i+1) + '. ' + r.name + '</label>' +
          '<select id="vote_' + i + '">' +
            '<option value="1">★☆☆☆☆ (1)</option>' +
            '<option value="2">★★☆☆☆ (2)</option>' +
            '<option value="3">★★★☆☆ (3)</option>' +
            '<option value="4">★★★★☆ (4)</option>' +
            '<option value="5">★★★★★ (5)</option>' +
          '</select>';
        rezContainer.appendChild(d);
      });

      btn.disabled = false;
    } catch(err) {
      console.error('loadRecipes error',err);
      rezContainer.innerHTML = '<p class="error">Fehler beim Laden der Rezepte.</p>';
    }
  }

  // 3️⃣ Submit: wir senden jetzt auch voting_id mit
  btn.addEventListener('click', async () => {
    btn.disabled = true;
    const count = Number(countSelect.value);
    const votes = rezepte.map((r,i) => ({
      recipe_id: r.id,
      vote:      Number(document.getElementById('vote_' + i).value)
    }));

    try {
      const resp = await fetch(WORKER, {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({
          household_id:     householdId,
          voting_record_id: window.__VOTING_RECORD_ID,
          count,
          votes
        })
      });
      const j = await resp.json();
      if (j.success) {
        alert('Danke fürs Voting!');
      } else {
        alert('Fehler: ' + (j.error||'unbekannt'));
      }
    } catch(err) {
      console.error('submit error',err);
      alert('Netzwerk-Fehler.');
    } finally {
      btn.disabled = false;
    }
  });

  loadRecipes();
});
</script>
